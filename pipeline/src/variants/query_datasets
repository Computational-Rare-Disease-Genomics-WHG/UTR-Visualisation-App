#!/bin/sh
# This script filters a VCF file using tabix and saves the results as a TSV file
# The script takes three arguments:
# 1. The input VCF file
# 2. The output TSV file
# 3. The region file to use for filtering

# Check if the input file argument was provided
if [ $# -eq 0 ]; then
    echo "Usage: $0 input_file output_file tabix_region_file type"
    exit 1
fi

# Get the input file path from the command-line argument
input=$1

# Check if the input file exists
if [ ! -f $input ]; then
    echo "Input file not found: $input"
    exit 1
fi

# Get the output file path from the command-line argument
output=$2

# First check if the output file already exists
if [ -f $output ]; then
    echo "Output file already exists: $output"
    exit 1
fi

# Get the region file path from the command-line argument
region=$3


type=$4

# Define the headers for the output TSV file
if [ $type = "gnomad" ]; then
    # If type is gnomad, then we need to add the following headers
    # NOTE: 
    # We require the following headers from gnomAD
    # CHROM, POS, ID, HGVSC, INFO/AC, INFO/AN, INFO/AF, INFO/vep, INFO/variant_type
    headers='chrom\tpos\tref\talt\tid\thgvsc\tac\tan\taf\tvep\tvariant_type\n'
    query_string='%CHROM\t%POS\t%REF\t%ALT\t%ID\t%HGVSC\t%INFO/AC\t%INFO/AN\t%INFO/AF\t%INFO/vep\t%INFO/variant_type\n'
# Otherwise if clinvar, then we need to add the following headers
elif [ $type  = 'clinvar']; then
    # NOTE:
    # We require the following headers from ClinVar
    # CHROM, POS, REF, ALT, ID, CLNSIG, CLNREVSTAT, CLNDN, CLNDISDB, CLNVC, CLNHGVS, CLNVI
    headers='chrom\tpos\tref\talt\tid\tclnsig\tclnrevstat\tclndn\tclndisdb\tclnvc\tclnhgvs\tclnvi\n'
    query_string='%CHROM\t%POS\t%REF\t%ALT\t%ID\t%INFO/CLNSIG\t%INFO/CLNREVSTAT\t%INFO/CLNDN\t%INFO/CLNDISDB\t%INFO/CLNVC\t%INFO/CLNHGVS\t%INFO/CLNVI\n'

fi

# Filter using tabix using the specified region file 
# and perform query save to the output file
echo -e $headers > $output && tabix -h $input -R $region | bcftools query -f $query_string >> $output

echo "Filtered TSV file saved to $output"
