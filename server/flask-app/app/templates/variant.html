<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>Variant | VuTR</title>
      <!-- Google Font: Source Sans Pro -->
      <link rel="preconnect" href="https://fonts.gstatic.com">
      <!--Favicon-->
      <link rel="shortcut icon" href="{{url_for('static', filename='favicon.png')}}" type="image/x-icon">
      <!--Google Font API-->
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <!--Fonts-->
      <link href="https://fonts.googleapis.com/css2?family=Alegreya+Sans:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">
      <link whref="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
      <!-- Font Awesome -->
      <link rel="stylesheet" href="{{url_for('static', filename = 'plugins/fontawesome-free/css/all.min.css')}}">
      <link rel="stylesheet" href="{{url_for('static', filename = 'plugins/fontawesome-free/css/brands.css')}}">
      <!-- Ionicons -->
      <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
      <!-- Tempusdominus Bootstrap 4 -->
      <link rel="stylesheet" href="{{url_for('static', filename = 'plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css')}}">
      <!-- iCheck -->
      <link rel="stylesheet" href="{{url_for('static', filename = 'plugins/icheck-bootstrap/icheck-bootstrap.min.css')}}">
      <!-- JQVMap -->
      <link rel="stylesheet" href="{{url_for('static', filename = 'plugins/jqvmap/jqvmap.min.css')}}">
      <!-- Theme style -->
      <link rel="stylesheet" href="{{url_for('static', filename = 'dist/css/adminlte.min.css')}}">
      <!-- overlayScrollbars -->
      <link rel="stylesheet" href="{{url_for('static', filename = 'plugins/overlayScrollbars/css/OverlayScrollbars.min.css')}}">



      <!--Preload scripts-->
      <script src="https://cdn.jsdelivr.net/gh/calipho-sib/feature-viewer@v1.1.0/dist/feature-viewer.bundle.js"></script>
      <script src="https://unpkg.com/d3"></script>
      <script src="https://unpkg.com/d3fc"></script>

      <style type="text/css">
         .select2-container--default .select2-selection--multiple .select2-selection__choice {
         background-color: #007bff;
         border-color: #006fe6;
         }
         p,
         h1,
         h2,
         h3,
         h4,
         h5,
         h6,
         a {
         font-family: 'Roboto';
         font-weight: 400;
         }
         #chart {
         color: #1b1e23;
         font-size: small;
         font-family: sans-serif;
         height: calc(100vh - 2em);
         margin: 1em;
         display: flex;
         }
         #chart>* {
         flex: auto;
         }
         .domain,
         .gridline-y,
         .gridline-x,
         .annotation-line>line {
         stroke: currentColor;
         stroke-opacity: 0.1;
         }
         .tooltip2, .tooltip3{
         display:none;
      }

      </style>
   </head>
   <body class="hold-transition layout-top-nav" id="main-content" >
      <div class="wrapper">
         <!-- Navbar -->
         <nav class="main-header navbar navbar-expand navbar-light" >
            <!-- Left navbar links -->
            <ul class="navbar-nav">
                <li class="nav-item d-none d-sm-inline-block">
                   <a href="{{url_for('main.index')}}" class="nav-link">Home</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                   <a href="{{url_for('main.about')}}" class="nav-link">About</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                   <a href="{{url_for('main.help_page')}}" class="nav-link">Help</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                   <a href="mailto:nwhiffin@well.ox.ac.uk" class="nav-link">Contact</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                   <a href="{{url_for('main.changelog')}}" class="nav-link">Changelog</a>
                </li>

            </ul>

            <!-- Right navbar links -->
            <ul class="navbar-nav ml-auto">
               <!-- Navbar Search -->
               <li class="nav-item">
                  <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                  <i class="fas fa-expand-arrows-alt"></i>
                  </a>
               </li>
            </ul>
         </nav>
         <!-- /.navbar -->
         <!-- Content Wrapper. Contains page content -->
         <div class="content-wrapper" >
            <!-- Content Header (Page header) -->
            <div class="content-header">
                <div class="container-fluid">

                    <div class="row">
                        <div class="col-9 mx-auto">
                            <h2 class="">Search by Variant ID</h2>
                            <p>The variant {{variant}} falls in the 5' UTRs of the following transcripts. Select a transcript to proceed.</p>
                            <hr>
                            {% for transcript in variant_list %}


                           <div class="card">
                              <div class="card-header">
                                 More details : <a href="{{url_for('viewer.viewer_page', ensembl_transcript_id=transcript['ensembl_transcript_id'])}}">{{transcript['ensembl_transcript_id']}}</a>
                              </div>

                              <div class="card-body">
                                 <div id="{{transcript['ensembl_transcript_id']}}-viewer">
                                 </div>

                              </div>

                           </div>


                            {% endfor %}


                        </div>
                    </div>
                </div>
            </div>
         </div>
      <!-- /.content -->
      </div>
      <!-- /.content-wrapper -->
      <footer class="main-footer mx-auto">
         <div class="row mx-auto">
         <strong class="text-center mx-auto">Copyright &copy; 2022 <a href="https://rarediseasegenomics.org/">Computational Rare Disease Genomics</a></strong>.
      </div>
      </footer>
      <!-- Control Sidebar -->
      <aside class="control-sidebar control-sidebar-dark">
      </aside>
      <!-- /Control sidebar -->
      </div>
      <!-- jQuery -->
      <script src="{{url_for('static', filename = 'plugins/jquery/jquery.min.js')}}"></script>
      <!-- jQuery UI 1.11.4 -->
      <script src="{{url_for('static', filename = 'plugins/jquery-ui/jquery-ui.min.js')}}"></script>
      <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
      <script>
         $.widget.bridge('uibutton', $.ui.button)



      </script>
      <!-- Bootstrap 4 -->
      <script src="{{url_for('static', filename = 'plugins/bootstrap/js/bootstrap.bundle.min.js')}}"></script>
      <!-- ChartJS -->
      <script src="{{url_for('static', filename = 'plugins/chart.js/Chart.min.js')}}"></script>
      <!-- Sparkline -->
      <script src="{{url_for('static', filename = 'plugins/sparklines/sparkline.js')}}"></script>
      <!-- JQVMap -->
      <script src="{{url_for('static', filename = 'plugins/jqvmap/jquery.vmap.min.js')}}"></script>
      <script src="{{url_for('static', filename = 'plugins/jqvmap/maps/jquery.vmap.usa.js')}}"></script>
      <!-- jQuery Knob Chart -->
      <script src="{{url_for('static', filename = 'plugins/jquery-knob/jquery.knob.min.js')}}"></script>
      <!-- daterangepicker -->
      <script src="{{url_for('static', filename = 'plugins/moment/moment.min.js')}}"></script>
      <script src="{{url_for('static', filename = 'plugins/daterangepicker/daterangepicker.js')}}"></script>
      <!-- Tempusdominus Bootstrap 4 -->
      <script src="{{url_for('static', filename = 'plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js')}}"></script>
      <!-- Summernote -->
      <script src="{{url_for('static', filename = 'plugins/summernote/summernote-bs4.min.js')}}"></script>
      <!-- overlayScrollbars -->
      <script src="{{url_for('static', filename = 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js')}}"></script>
      <!-- AdminLTE App -->
      <script src="{{url_for('static', filename = 'dist/js/adminlte.js')}}"></script>
      <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
      <script src="{{url_for('static', filename = 'dist/js/pages/dashboard.js')}}"></script>
      <script src="{{url_for('static', filename = 'plugins/select2/js/select2.full.min.js')}}"></script>
      <script src="{{url_for('static', filename ='plugins/jsgrid/jsgrid.min.js')}}"></script>

      <!--UTR Visualization-->
      <script src="{{url_for('static', filename ='utrviewer.js')}}"></script>
      <script src="{{url_for('static', filename ='variant_table.js')}}"></script>
      
      <!--Custom Scripts-->

      <script>
      var None, nan = null;
      var variant_dat_list = {{variant_dat_list | safe}};
      var buffer = 40;
      var variant = '{{variant | safe}}';
      var impact_url = '{{impact_url | safe}}';
      variant_dat_list.forEach((var_impact, index) => {
         var seq = var_impact['five_prime_utr_stats']['seq'];
         var start_site = var_impact['five_prime_utr_stats']['five_prime_utr_length'];
         var genomic_features = var_impact['gene_features'];
         var strand = genomic_features[0]['strand'];
         var div = '#'+var_impact['ensembl_transcript_id']+'-viewer';
         var ensembl_transcript_id = var_impact['ensembl_transcript_id'];


         console.log(div)

         // Subset to the first 100 bases following the CDS
         var sequence = strand == "+" ? seq
            .substring(0, start_site + buffer) :
            reverse(seq.substring(0, start_site + buffer));


         // Create the feature viewer
         var ft = new FeatureViewer.createFeature(sequence, div, {
            showAxis: false,
            showSequence: true,
            brushActive: true,
            toolbar: false,
            bubbleHelp: true,
            zoomMax: 10
         })
         //********** Gene Structure *********/
         // Plot where the coding sequence and 5' utrs
         if (start_site != 0) {
            ft.addFeature({
                  data: [{
                        x: strand_corrected_interval(start_site + 1, start_site + buffer, start_site, buffer, strand)['start'],
                        y: strand_corrected_interval(start_site + 1, start_site + buffer, start_site, buffer, strand)['end'],
                        color: '#58565F',
                        description: "\t\tCDS",
                        id: 'cds_rect',
                     },
                     {
                        x: strand_corrected_interval(1, start_site, start_site, buffer, strand)['start'],
                        y: strand_corrected_interval(1, start_site, start_site, buffer, strand)['end'],
                        color: '#A4AAAC',
                        description: "\t\t5' UTR",
                        id: 'utr_rect'
                     }
                  ],
                  name: "Gene Structure",
                  className: "gene_struct",
                  type: "rect",
                  color: "#A4AAAC"
            });
            document.getElementById("fcds_rect").setAttribute("height", "30");
            document.getElementById("fcds_rect").setAttribute("y", "-8");

            ft.addFeature({
                  data: get_exon_structure(genomic_features, buffer, start_site, strand),
                  color:'#2C302E',
                  name : 'Exon Structure',
                  className : 'exon_struct',
                  type: 'rect',
                  color : '#000000'
            });
         }

         $.ajax({
            url: impact_url,
            data: {
               'variant_id': variant,
               'ensembl_transcript_id' : ensembl_transcript_id,
               'start_site' : start_site,
               'buffer' : buffer
            },
            error : function (e){
               console.log(e)
            },
            success: function(res){

               // Create visualization
               add_user_supplied_feature(ft,
                  res,
                  variant,
                  start_site,
                  buffer,
                  strand
               );
            },
            dataType: 'json'
         });



      });

      </script>

   </body>
</html>
